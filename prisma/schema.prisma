// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication
// Roles: "user", "admin", "admin-main" (super admin), "lawyer", "accountant", "ops"
model User {
  id               String    @id @default(cuid())
  email            String    @unique
  name             String?
  password         String
  role             String    @default("user")
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  lastLoginAt      DateTime?
  loginAttempts    Int       @default(0)
  lockedUntil      DateTime?
  
  // Email verification
  emailVerified    Boolean   @default(false)
  verificationToken String?  @unique
  verificationTokenExpiry DateTime?
  
  // Password reset
  passwordResetToken   String?   @unique
  passwordResetExpires DateTime?

  // Relations
  appointments     Appointment[]
  orders           Order[]
  contactMessages  ContactMessage[]
  conversations    Conversation[]
  sentMessages     Message[]
  stripeDeposits   StripeDeposit[]
  deposits         Deposit[]
  paymentReceipts  PaymentReceipt[]
  treasuryTransfers TreasuryTransfer[]
  
  // Approval workflow relations
  requestedApprovals  ApprovalRequest[] @relation("RequestedApprovals")
  assignedApprovals   ApprovalRequest[] @relation("AssignedApprovals")
  uploadedAttachments ApprovalAttachment[]
}

// Product model for e-commerce
model Product {
  id               String    @id @default(cuid())
  name             String
  description      String?
  category         String
  price            Int       // in cents
  stripePriceId    String    @unique
  stripeProductId  String
  features         String[]
  salesCount       Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  orderItems       OrderItem[]
}

// Appointment model for booking system
model Appointment {
  id               String    @id @default(cuid())
  userId           String?   // Optional: only set if booked by authenticated user
  user             User?     @relation(fields: [userId], references: [id])
  
  clientName       String
  clientEmail      String
  clientPhone      String?
  
  startTime        DateTime
  endTime          DateTime
  duration         Int       // in minutes
  notes            String?
  billableHours    Float     @default(0)
  workNotes        String?
  
  // Consultation type
  consultationType String    @default("free")     // free, paid ($50)
  consultationSource String?                      // landing, product_upsell
  
  // Approval timestamps (status is the source of truth)
  approvedAt       DateTime?
  rejectedAt       DateTime?
  
  // Status: pending_approval -> confirmed/cancelled -> completed
  status           String    @default("pending_approval")
  
  // Video conferencing
  meetingLink      String?
  meetingType      String?   // daily, zoom, google_meet, none
  meetingData      Json?     // Store meeting-specific data
  
  // Session access
  sessionToken     String?   @unique
  sessionExpiresAt DateTime?
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  @@index([userId])
  @@index([clientEmail])
}

// Availability model for admin scheduling
model Availability {
  id               String    @id @default(cuid())
  dayOfWeek        Int       // 0-6 (Sunday-Saturday)
  startTime        String    // HH:MM format
  endTime          String    // HH:MM format
  timezone         String    @default("UTC")
  isActive         Boolean   @default(true)
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  @@unique([dayOfWeek, startTime, endTime])
}

// Order model for order tracking
model Order {
  id               String    @id @default(cuid())
  userId           String?
  user             User?     @relation(fields: [userId], references: [id])
  
  stripeSessionId  String    @unique
  stripeCustomerId String?
  
  total            Int       // in cents
  currency         String    @default("usd")
  status           String    @default("pending") // pending, completed, failed, refunded
  
  customerEmail    String
  customerName     String?
  
  // Items in order
  items            OrderItem[]
  
  // Delivery/fulfillment
  downloadLinks    String[]  // For digital products
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  completedAt      DateTime?
  
  @@index([stripeSessionId])
  @@index([customerEmail])
  @@index([userId])
}

// OrderItem model for line items
model OrderItem {
  id               String    @id @default(cuid())
  orderId          String
  order            Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId        String
  product          Product   @relation(fields: [productId], references: [id])
  
  quantity         Int       @default(1)
  priceAtTime      Int       // Price in cents at time of purchase
  
  createdAt        DateTime  @default(now())
  
  @@index([orderId])
  @@index([productId])
}

// Contact message model for lead capture
model ContactMessage {
  id               String    @id @default(cuid())
  userId           String?
  user             User?     @relation(fields: [userId], references: [id])
  
  name             String
  email            String
  phone            String?
  subject          String
  message          String
  
  status           String    @default("new") // new, read, replied, archived
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  @@index([email])
  @@index([status])
}

// Email log for tracking sent emails
model EmailLog {
  id               String    @id @default(cuid())
  to               String
  subject          String
  type             String    // appointment_confirmation, order_confirmation, contact_reply, password_reset
  
  status           String    @default("sent") // sent, failed, bounced
  errorMessage     String?
  
  createdAt        DateTime  @default(now())
  
  @@index([to])
  @@index([type])
}
// Newsletter subscriber model for marketing automation
model NewsletterSubscriber {
  id               String    @id @default(cuid())
  email            String    @unique
  status           String    @default("active") // active, unsubscribed, bounced
  
  subscribedAt     DateTime  @default(now())
  unsubscribedAt   DateTime?
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  @@index([email])
  @@index([status])
}

// In-app messaging system
model Conversation {
  id            String    @id @default(cuid())
  userId        String?   // null for guest conversations
  user          User?     @relation(fields: [userId], references: [id])
  guestEmail    String?   // for non-registered users
  guestName     String?
  subject       String
  status        String    @default("open") // open, closed, archived
  messages      Message[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId])
  @@index([status])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String?      // null = guest or system
  sender         User?        @relation(fields: [senderId], references: [id])
  senderType     String       // "guest", "user", "admin", "admin-main"
  content        String
  attachments    Attachment[]
  readAt         DateTime?
  createdAt      DateTime     @default(now())

  @@index([conversationId])
  @@index([senderId])
}

model Attachment {
  id        String   @id @default(cuid())
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  url       String
  filename  String
  mimeType  String
  size      Int
  createdAt DateTime @default(now())

  @@index([messageId])
}

// Stripe deposit tracking for USD deposits
model StripeDeposit {
  id                    String    @id @default(cuid())
  userId                String
  user                  User      @relation(fields: [userId], references: [id])
  
  amountUsd             Int       // Amount in cents
  stripeSessionId       String    @unique
  stripePaymentIntentId String?   @unique
  
  // Status: pending -> completed -> settled (or failed)
  status                String    @default("pending")
  
  // Link to deposit record for Kraken settlement
  depositId             String?   @unique
  deposit               Deposit?  @relation(fields: [depositId], references: [id])
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  completedAt           DateTime?
  
  @@index([userId])
  @@index([status])
}

// Deposit record for exchange funding (Kraken settlement bookkeeping)
model Deposit {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  
  amountUsd       Int       // Amount in cents
  source          String    @default("stripe") // stripe, bank_transfer, etc.
  
  // Status: pending_kraken -> submitted -> confirmed (or failed)
  status          String    @default("pending_kraken")
  
  // Kraken settlement tracking
  krakenOrderId   String?   // Future: actual Kraken order ID
  settledAt       DateTime?
  settlementNotes String?
  
  // Link back to Stripe deposit
  stripeDeposit   StripeDeposit?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@index([status])
}

// Generalized payment receipt for all payment methods (Stripe, Cash, ACH, Wire, etc.)
model PaymentReceipt {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  
  // Payment method: STRIPE, CASH, ACH, WIRE, CHECK, OTHER
  method          String
  
  amountCents     Int       // Amount in cents
  currency        String    @default("USD")
  
  // Status: PENDING, PENDING_APPROVAL, APPROVED, REJECTED, RECEIVED, FAILED, REFUNDED
  status          String    @default("PENDING")
  
  receivedAt      DateTime?
  
  // External reference (Stripe session ID, bank ref, check number, etc.)
  externalRef     String?
  
  // Description/notes for audit trail
  description     String?
  notes           String?
  
  // Optional: client info for non-user payments
  clientName      String?
  clientEmail     String?
  
  // Link to treasury transfer if funds were moved to Kraken
  treasuryTransfers TreasuryTransfer[]
  
  // Link to approval request (for cash/large payments)
  approvalRequest   ApprovalRequest?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@index([method])
  @@index([status])
  @@index([receivedAt])
}

// Treasury transfer tracking (Fulton Bank -> Kraken, etc.)
model TreasuryTransfer {
  id                  String    @id @default(cuid())
  userId              String    // Admin who created the transfer
  user                User      @relation(fields: [userId], references: [id])
  
  // Source account: FULTON_BANK, STRIPE_BALANCE, CASH_ON_HAND
  sourceAccount       String
  
  // Destination: KRAKEN, COINBASE, etc.
  destinationAccount  String    @default("KRAKEN")
  
  // Transfer method: ACH, WIRE
  method              String
  
  amountCents         Int
  currency            String    @default("USD")
  
  // Status: PLANNED, SUBMITTED, CONFIRMED, CANCELED
  status              String    @default("PLANNED")
  
  // Timestamps for audit trail
  plannedAt           DateTime  @default(now())
  submittedAt         DateTime?
  confirmedAt         DateTime?
  
  // External references
  bankRef             String?   // Bank confirmation/reference number
  krakenRef           String?   // Kraken deposit reference
  
  notes               String?
  
  // Optional link to payment receipt(s) this transfer is funding
  paymentReceiptId    String?
  paymentReceipt      PaymentReceipt? @relation(fields: [paymentReceiptId], references: [id])
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([sourceAccount])
  @@index([destinationAccount])
}

// Approval request for cash payments requiring lawyer/team sign-off
model ApprovalRequest {
  id                  String    @id @default(cuid())
  
  // Link to the payment being approved
  paymentReceiptId    String    @unique
  paymentReceipt      PaymentReceipt @relation(fields: [paymentReceiptId], references: [id])
  
  // Who requested approval
  requestedById       String
  requestedBy         User      @relation("RequestedApprovals", fields: [requestedById], references: [id])
  requestedAt         DateTime  @default(now())
  
  // Who should approve (lawyer, accountant, ops, admin)
  assignedToId        String
  assignedTo          User      @relation("AssignedApprovals", fields: [assignedToId], references: [id])
  assignedRole        String    // LAWYER, ACCOUNTANT, OPS, ADMIN
  
  // Status: PENDING, APPROVED, REJECTED
  status              String    @default("PENDING")
  
  // Decision tracking
  decisionAt          DateTime?
  decisionNotes       String?
  rejectionReason     String?
  
  // Secure token for external approval links (magic link)
  approvalToken       String?   @unique
  tokenExpiresAt      DateTime?
  
  // Link to conversation for discussion
  conversationId      String?
  
  // Attachments (receipt photos, etc.)
  attachments         ApprovalAttachment[]
  
  notes               String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@index([requestedById])
  @@index([assignedToId])
  @@index([status])
  @@index([approvalToken])
}

// Attachments for approval requests (receipt photos, documents)
model ApprovalAttachment {
  id                  String    @id @default(cuid())
  
  approvalRequestId   String
  approvalRequest     ApprovalRequest @relation(fields: [approvalRequestId], references: [id], onDelete: Cascade)
  
  url                 String
  filename            String
  mimeType            String
  size                Int       // bytes
  
  uploadedById        String
  uploadedBy          User      @relation(fields: [uploadedById], references: [id])
  
  createdAt           DateTime  @default(now())
  
  @@index([approvalRequestId])
}